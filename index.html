<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>画像→機種名 抽出ツール（単一HTML版）</title>
  <!-- ✅ 外部ライブラリ（CDN） -->
  <!-- Tesseract.js 本体 -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <!-- FileSaver（CSV保存用） -->
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <style>
    :root { --bg:#0f1115; --panel:#151923; --ink:#e6e6e6; --muted:#a0a8b7; --acc:#4da3ff; }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{font-size:20px;margin:0 0 12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .card{background:var(--panel);border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .card h2{font-size:16px;margin:0 0 8px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:1px solid #2a3242;background:#1b2231;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{border-color:#245aa6;background:#1a3a62}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    input[type=file]{display:none}
    .drop{border:1px dashed #3a4255;border-radius:12px;padding:16px;text-align:center;color:var(--muted)}
    .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;margin-top:8px}
    .thumb{position:relative;border:1px solid #2c3446;border-radius:10px;overflow:hidden}
    .thumb img{width:100%;display:block}
    .thumb .cap{position:absolute;left:6px;bottom:6px;background:rgba(0,0,0,.55);padding:2px 6px;border-radius:6px;font-size:12px}
    .log{height:200px;overflow:auto;background:#0d1119;border-radius:12px;padding:8px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Noto Sans Mono", monospace}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f2746;color:#a6c8ff;border:1px solid #214a84;margin-right:6px}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:6px;align-items:center}
    .ok{color:#91ffa5}
    .ng{color:#ff9e9e}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Noto Sans Mono", monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>画像→機種名 抽出ツール（PNG/JPG 対応）</h1>

    <div class="grid">
      <!-- 左：画像投入 -->
      <section class="card">
        <h2>① 画像を投入（複数OK / PNG・JPG）</h2>
        <div id="imageDrop" class="drop">ここにファイルをドロップ、または <label class="btn" for="imageInput">画像を選択</label><input id="imageInput" type="file" accept="image/*" multiple></div>
        <div class="thumbs" id="thumbs"></div>
        <div class="row" style="margin-top:12px">
          <button class="btn primary" id="runOcrBtn" disabled>OCRを実行</button>
          <span id="progress" class="muted"></span>
        </div>
      </section>

      <!-- 右：マスターCSV投入＆出力 -->
      <section class="card">
        <h2>② マスターCSVを読み込み（正式名称リスト / 1行=1機種）</h2>
        <div id="masterDrop" class="drop">ここにCSVをドロップ、または <label class="btn" for="masterInput">CSVを選択</label><input id="masterInput" type="file" accept=".csv"></div>
        <div class="kv" style="margin:10px 0 6px">
          <div>読み込み状態</div>
          <div><span class="pill" id="masterState">未読込</span> <span id="masterCount" class="muted"></span></div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="dlOfficial" disabled>CSVダウンロード（正式名のみ）</button>
          <button class="btn" id="dlDetailed" disabled>CSVダウンロード（詳細）</button>
        </div>
      </section>
    </div>

    <section class="card" style="margin-top:16px">
      <h2>ログ / 結果</h2>
      <div id="log" class="log"></div>
    </section>

    <p class="muted">【使い方】1) PNG/JPGを入れる → 2) マスターCSV（正式名称1列）を読み込む → 3) 「OCRを実行」→ 4) CSV保存</p>
  </div>

  <script>
  // ===== ユーティリティ（DOM, ログ） =====
  const $ = (q) => document.querySelector(q);
  const $$ = (q) => [...document.querySelectorAll(q)];
  const logBox = $('#log');
  function log(msg, cls=""){
    const d = document.createElement('div');
    if(cls) d.className = cls;
    d.textContent = msg;
    logBox.appendChild(d);
    logBox.scrollTop = logBox.scrollHeight;
  }
  function clearLog(){ logBox.textContent = ""; }

  // ===== 状態 =====
  const state = {
    images: /** @type {File[]} */([]),
    masterOfficial: /** @type {string[]} */([]),
    masterLooseSet: new Set(),
    masterLooseToOfficial: new Map(),
    results: /** @type {Array<{src:string, raw:string, norm:string, loose:string, matched:string|null, score:number}>} */([]),
  };

  // ===== 正規化 =====
  const NameNormalizer = {
    toHalfWidth(s){
      return s.replace(/[！-～]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0))
              .replace(/　/g, ' ');
    },
    kanaToHira(s){
      return s.replace(/[ァ-ヶ]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0x60));
    },
    basicClean(s){
      return s
        .replace(/["'`]/g, '')
        .replace(/[()（）\[\]【】]/g, ' ')
        .replace(/[‐‑–—―ー−-]/g, '-')
        .replace(/[·・•]/g, '・')
        .replace(/[~～]/g, '')
        .replace(/[.,。､、]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
    },
    normalize(s){
      if(!s) return '';
      s = this.toHalfWidth(s);
      s = this.kanaToHira(s);
      s = s.toLowerCase();
      s = this.basicClean(s);
      return s;
    },
    makeLooseKey(s){
      // 記号・スペース・数字を落として、比較用キーに
      return this.normalize(s).replace(/[^ぁ-んa-z0-9]/g, '');
    }
  };

  // ===== 文字列類似度（Dice係数, 2-gram） =====
  function diceCoefficient(a, b){
    if(a === b) return 1;
    if(a.length < 2 || b.length < 2) return 0;
    const bigrams = new Map();
    for(let i=0;i<a.length-1;i++){
      const bg = a.slice(i,i+2);
      bigrams.set(bg, (bigrams.get(bg)||0) + 1);
    }
    let matches = 0;
    for(let i=0;i<b.length-1;i++){
      const bg = b.slice(i,i+2);
      const count = bigrams.get(bg) || 0;
      if(count > 0){
        bigrams.set(bg, count - 1);
        matches++;
      }
    }
    return (2 * matches) / (a.length + b.length - 2);
  }

  // ===== マスターCSV読込 =====
  async function readTextFile(file){
    return new Promise((res, rej)=>{
      const fr = new FileReader();
      fr.onerror = () => rej(fr.error);
      fr.onload = () => res(String(fr.result||''));
      fr.readAsText(file, 'utf-8');
    });
  }

  async function loadMasterCsv(file){
    const text = await readTextFile(file);
    // 1列CSV（見出し無し）想定。空行はスキップ
    const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const official = [];
    const looseToOfficial = new Map();
    const looseSet = new Set();
    for(const line of lines){
      const off = line; // そのまま正式名称
      const loose = NameNormalizer.makeLooseKey(off);
      if(!loose) continue;
      official.push(off);
      // 重複キーの時は先勝ち（既に登録済みならスキップ）
      if(!looseSet.has(loose)){
        looseSet.add(loose);
        looseToOfficial.set(loose, off);
      }
    }
    state.masterOfficial = official;
    state.masterLooseSet = looseSet;
    state.masterLooseToOfficial = looseToOfficial;
    $('#masterState').textContent = '読込済み';
    $('#masterCount').textContent = `${official.length} 件`;
    log(`マスターCSV：${official.length}件を読み込みました。`);
    refreshButtons();
  }

  // ===== 画像→OCR =====
  async function ocrImage(file){
    return new Promise((res, rej)=>{
      const reader = new FileReader();
      reader.onerror = () => rej(reader.error);
      reader.onload = async () => {
        try{
          const { data } = await Tesseract.recognize(reader.result, 'jpn', {
            logger: m => { if(m.status==='recognizing text'){ setProgress(`OCR中: ${file.name} ${(m.progress*100).toFixed(1)}%`); } }
          });
          res(String(data.text||''));
        }catch(err){ rej(err); }
      };
      reader.readAsDataURL(file);
    });
  }

  function splitLines(raw){
    return raw
      .replace(/\r/g,'')
      .split('\n')
      .map(s=>s.trim())
      .filter(s=>s && !/^新台|おすすめ|本日|明日|本命|ラインナップ/i.test(s));
  }

  function matchToMaster(line){
    const norm = NameNormalizer.normalize(line);
    const loose = NameNormalizer.makeLooseKey(line);
    if(!loose) return { matched:null, score:0, norm, loose };

    // 1) ルーズキー完全一致
    if(state.masterLooseSet.has(loose)){
      return { matched: state.masterLooseToOfficial.get(loose) || null, score: 1, norm, loose };
    }
    // 2) 類似（Dice）でしきい値以上
    let best = { off:null, score:0 };
    for(const off of state.masterOfficial){
      const l2 = NameNormalizer.makeLooseKey(off);
      if(!l2) continue;
      const sc = diceCoefficient(loose, l2);
      if(sc > best.score){ best = { off, score: sc }; }
    }
    const THRESH = 0.82; // ←調整ポイント（0.80～0.88目安）
    if(best.off && best.score >= THRESH){
      return { matched: best.off, score: best.score, norm, loose };
    }
    return { matched: null, score: best.score, norm, loose };
  }

  async function runOCR(){
    clearLog();
    if(!state.images.length){ log('画像が未選択です。','ng'); return; }
    if(!state.masterOfficial.length){ log('マスターCSVを読み込んでください。','ng'); return; }

    $('#runOcrBtn').disabled = true;
    setProgress('OCR開始');

    const out = [];
    for(const file of state.images){
      log(`OCR: ${file.name} を解析中…`);
      try{
        const text = await ocrImage(file);
        const lines = splitLines(text);
        log(`→ ${file.name}: ${lines.length} 行`);
        for(const raw of lines){
          const m = matchToMaster(raw);
          out.push({ src:file.name, raw, norm:m.norm, loose:m.loose, matched:m.matched, score:m.score });
        }
      }catch(err){
        console.error(err);
        log(`エラー (${file.name}): ${err.message||err}`,'ng');
      }
    }

    // 重複除去（matched優先→raw/normでユニーク化）
    const uniq = new Map();
    for(const r of out){
      const key = (r.matched || r.norm);
      if(!uniq.has(key)) uniq.set(key, r);
    }

    state.results = [...uniq.values()].sort((a,b)=>{
      // matchedの有無→スコア→rawで並べ替え
      if(!!b.matched - !!a.matched) return (b.matched?1:-1) - (a.matched?1:-1);
      if(b.score !== a.score) return b.score - a.score;
      return a.raw.localeCompare(b.raw, 'ja');
    });

    const ok = state.results.filter(r=>r.matched).length;
    const ng = state.results.length - ok;
    log(`\n結果: ${state.results.length} 件（一致 ${ok} / 未一致 ${ng}）`);
    setProgress('完了');
    refreshButtons();
  }

  // ===== CSV出力 =====
  function toOfficialOnlyCsv(){
    const rows = [ ['machine_official'] ];
    const seen = new Set();
    for(const r of state.results){
      if(!r.matched) continue;
      if(seen.has(r.matched)) continue;
      seen.add(r.matched);
      rows.push([r.matched]);
    }
    return rows.map(cols => cols.map(csvEscape).join(',')).join('\r\n');
  }

  function toDetailedCsv(){
    const rows = [[ 'source_image','raw','normalized','loose_key','matched_official','score' ]];
    for(const r of state.results){
      rows.push([ r.src, r.raw, r.norm, r.loose, r.matched||'', r.score.toFixed(3) ]);
    }
    return rows.map(cols => cols.map(csvEscape).join(',')).join('\r\n');
  }

  function csvEscape(v){
    const s = String(v==null? '': v);
    if(/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
    return s;
  }

  function downloadCsv(name, text){
    const blob = new Blob([text], { type:'text/csv;charset=utf-8' });
    saveAs(blob, name);
  }

  // ===== UI: ドロップ＆選択 =====
  function setupDropZone(zone, onFiles){
    zone.addEventListener('dragover', e=>{ e.preventDefault(); zone.style.borderColor='#4da3ff'; });
    zone.addEventListener('dragleave', e=>{ zone.style.borderColor=''; });
    zone.addEventListener('drop', e=>{
      e.preventDefault(); zone.style.borderColor='';
      const files = [...e.dataTransfer.files];
      onFiles(files);
    });
  }

  function setProgress(msg){ $('#progress').textContent = msg; }

  function refreshButtons(){
    $('#runOcrBtn').disabled = state.images.length===0 || state.masterOfficial.length===0;
    const hasResult = state.results.length>0 && state.results.some(r=>r.matched);
    $('#dlOfficial').disabled = !hasResult;
    $('#dlDetailed').disabled = state.results.length===0;
  }

  function previewImages(){
    const box = $('#thumbs');
    box.textContent = '';
    for(const f of state.images){
      const url = URL.createObjectURL(f);
      const div = document.createElement('div');
      div.className = 'thumb';
      div.innerHTML = `<img src="${url}"><span class="cap mono">${f.name}</span>`;
      box.appendChild(div);
    }
  }

  // ===== イベント束ね =====
  (function init(){
    setupDropZone($('#imageDrop'), files => {
      state.images = files.filter(f=>/^image\//.test(f.type));
      previewImages();
      refreshButtons();
      log(`${state.images.length} 件の画像を受け取りました。`);
    });

    setupDropZone($('#masterDrop'), files => {
      const f = files.find(x=>/\.csv$/i.test(x.name));
      if(!f){ log('CSVファイルが見つかりません。','ng'); return; }
      loadMasterCsv(f).catch(err=>{ log(`マスターCSV読込エラー: ${err.message||err}`,'ng'); });
    });

    $('#imageInput').addEventListener('change', e=>{
      state.images = [...e.target.files].filter(f=>/^image\//.test(f.type));
      previewImages();
      refreshButtons();
      log(`${state.images.length} 件の画像を選択しました。`);
    });

    $('#masterInput').addEventListener('change', e=>{
      const f = e.target.files[0];
      if(!f){ return; }
      loadMasterCsv(f).catch(err=>{ log(`マスターCSV読込エラー: ${err.message||err}`,'ng'); });
    });

    $('#runOcrBtn').addEventListener('click', runOCR);

    $('#dlOfficial').addEventListener('click', ()=>{
      const base = `machines_official_${new Date().toISOString().slice(0,10)}`;
      downloadCsv(`${base}.csv`, toOfficialOnlyCsv());
    });

    $('#dlDetailed').addEventListener('click', ()=>{
      const base = `machines_detailed_${new Date().toISOString().slice(0,10)}`;
      downloadCsv(`${base}.csv`, toDetailedCsv());
    });

    refreshButtons();
  })();
  </script>
</body>
</html>
